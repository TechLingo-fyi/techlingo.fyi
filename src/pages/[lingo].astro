---
import "@/styles/globals.css";
import LingoDetail from "@/components/LingoDetail";
import Layout from "@/layouts/Layout.astro";
import { getLingoPaths } from "@/code/paths";
import { useTranslations } from "@/l18n/ui";

export async function getStaticPaths() {
  return await getLingoPaths();
}

const { lingo, language } = Astro.params;
const { data, relatedLingos } = Astro.props;
const viewingLanguage = language ?? "en";
const lingoDescription = data.definitions.filter((definition) => {
  return definition.language === viewingLanguage;
})[0].definition;

const path = `https://${Astro.site?.hostname}/${lingo}/${viewingLanguage}`;
const shareableText = `${lingoDescription} ${path}`;
const translations = useTranslations(viewingLanguage);

const currentDefinition = data.definitions.find((def) => def.language === viewingLanguage);
const siteUrl = Astro.site?.toString() || "";
const lingoUrl = `${siteUrl}/${lingo}`;
const fullUrl = `${siteUrl}/${lingo}/${viewingLanguage}`;

// Get all available languages for hreflang tags
const availableLanguages = data.definitions.map((def) => def.language);

// DefinedTerm schema
const definedTermSchema = {
  "@context": "https://schema.org",
  "@type": "DefinedTerm",
  "name": data.term,
  "description": lingoDescription,
  "url": fullUrl,
  ...(currentDefinition?.expanded && { "alternateName": currentDefinition.expanded }),
  "inDefinedTermSet": {
    "@type": "DefinedTermSet",
    "name": "TechLingo.fyi",
    "url": siteUrl
  }
};

// BreadcrumbList schema
const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": "Home",
      "item": siteUrl
    },
    {
      "@type": "ListItem",
      "position": 2,
      "name": data.term,
      "item": fullUrl
    }
  ]
};
---

<Layout title={data.term} description={lingoDescription} path={path} lang={viewingLanguage}>
  {/* Hreflang tags for alternate language versions */}
  {availableLanguages.map((lang) => (
    <link rel="alternate" hreflang={lang} href={`${siteUrl}/${lingo}/${lang}`} />
  ))}
  <link rel="alternate" hreflang="x-default" href={`${siteUrl}/${lingo}/en`} />
  <script type="application/ld+json" set:html={JSON.stringify(definedTermSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
  <main id="main-content">
    <div class="flex items-center justify-center">
    <div class="grid grid-cols-3 gap-4 m-10 max-w-3xl min-w-3xl xl:min-w-3xl">
      <LingoDetail
        shareableText={shareableText}
        data={data}
        viewingLanguage={viewingLanguage}
        slug={lingo}
      />
      <div class="col-span-3 p-4">
        <h2 class="font-bold">{translations("lingo.relatedTerms")}</h2>
      </div>
      {
        relatedLingos.map((lingo) => (
          <a
            href={`/${lingo.slug}`}
            class="col-span-1 p-4 rounded-lg shadow"
            aria-label={`View related term: ${lingo.term}`}
          >
            <div>
              <h3 class="font-bold">{lingo.term}</h3>
            </div>
          </a>
        ))
      }
    </div>
    </div>
  </main>
</Layout>
